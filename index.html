<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DVT Log Analyzer - Obol Network</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            margin: 0; 
            font-family: system-ui, sans-serif; 
            background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 50%, #312e81 100%);
            min-height: 100vh;
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="loading" style="padding: 2rem; text-align: center; color: white;">
        <h1>DVT Log Analyzer</h1>
        <p>Loading Obol Network integration...</p>
    </div>
    
    <div id="root"></div>
    
    <script type="text/babel">
        try {
            console.log('Starting DVT Log Analyzer with Obol integration...');
            
            const { useState, useRef } = React;
            
            const DVTLogAnalyzer = () => {
                console.log('DVTLogAnalyzer component rendering...');
                
                const [files, setFiles] = useState([]);
                const [analysis, setAnalysis] = useState(null);
                const [loading, setLoading] = useState(false);
                const [useAI, setUseAI] = useState(false);
                const fileInputRef = useRef(null);

                const handleFileUpload = (event) => {
                    try {
                        const uploadedFiles = Array.from(event.target.files);
                        const processedFiles = uploadedFiles.map(file => ({
                            id: Math.random().toString(36).substr(2, 9),
                            name: file.name,
                            size: file.size,
                            type: getFileType(file.name),
                            file: file
                        }));
                        setFiles(prev => [...prev, ...processedFiles]);
                        console.log('Files uploaded:', processedFiles.length);
                    } catch (error) {
                        console.error('File upload error:', error);
                        alert('Error uploading files');
                    }
                };

                const getFileType = (filename) => {
                    const name = filename.toLowerCase();
                    if (name.includes('charon')) return 'charon';
                    if (name.includes('lighthouse')) return 'lighthouse';
                    if (name.includes('mev') || name.includes('boost')) return 'mev-boost';
                    if (name.includes('beacon')) return 'beacon';
                    if (name.includes('lodestar')) return 'lodestar';
                    return 'other';
                };

                const formatFileSize = (bytes) => {
                    if (bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                };

                const readFileContent = async (file) => {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = e => resolve(e.target.result);
                        reader.onerror = reject;
                        reader.readAsText(file);
                    });
                };

                // Helper functions for Obol documentation integration
                const categorizeError = (line) => {
                    const lowerLine = line.toLowerCase();
                    if (lowerLine.includes('consensus') || lowerLine.includes('qbft')) return 'consensus';
                    if (lowerLine.includes('relay') || lowerLine.includes('mev')) return 'mev-boost';
                    if (lowerLine.includes('charon')) return 'charon';
                    if (lowerLine.includes('network') || lowerLine.includes('p2p')) return 'network';
                    if (lowerLine.includes('beacon') || lowerLine.includes('lighthouse')) return 'beacon';
                    return 'general';
                };

                const detectCharonIssueType = (line) => {
                    const lowerLine = line.toLowerCase();
                    if (lowerLine.includes('consensus') || lowerLine.includes('qbft')) return 'consensus';
                    if (lowerLine.includes('p2p') || lowerLine.includes('discovery')) return 'networking';
                    if (lowerLine.includes('key') || lowerLine.includes('signature')) return 'key-management';
                    if (lowerLine.includes('config')) return 'configuration';
                    return 'general';
                };

                const extractRelayName = (line) => {
                    const lowerLine = line.toLowerCase();
                    if (lowerLine.includes('flashbots')) return 'flashbots';
                    if (lowerLine.includes('bloxroute')) return 'bloxroute';
                    if (lowerLine.includes('titan')) return 'titan';
                    if (lowerLine.includes('ultrasound')) return 'ultrasound';
                    if (lowerLine.includes('eden')) return 'eden';
                    if (lowerLine.includes('manifold')) return 'manifold';
                    if (lowerLine.includes('agnostic')) return 'agnostic';
                    if (lowerLine.includes('securerpc')) return 'securerpc';
                    return 'unknown-relay';
                };

                // Enhanced Local Analysis with Obol Documentation
                const analyzeLogsLocally = async (filesWithContent) => {
                    console.log('Starting enhanced local analysis with Obol documentation...');
                    
                    let report = "# DVT Log Analysis Report (Enhanced with Obol Documentation)\n\n";
                    
                    let errorCount = 0;
                    let warningCount = 0;
                    let criticalErrors = [];
                    let totalLines = 0;
                    let consensusEvents = [];
                    let relayIssues = [];
                    let charonIssues = [];
                    let networkIssues = [];
                    let timestamps = [];
                    
                    // Obol Documentation Links
                    const obolDocs = {
                        base: "https://docs.obol.org",
                        quickStart: "https://docs.obol.org/docs/start/quickstart_group",
                        troubleshooting: "https://docs.obol.org/docs/advanced/troubleshooting",
                        monitoring: "https://docs.obol.org/docs/advanced/monitoring",
                        networking: "https://docs.obol.org/docs/advanced/networking",
                        mevBoost: "https://docs.obol.org/docs/advanced/mev-boost",
                        charon: "https://docs.obol.org/docs/charon/intro",
                        charonConfig: "https://docs.obol.org/docs/charon/run/docker",
                        consensus: "https://docs.obol.org/docs/learn/intro",
                        cluster: "https://docs.obol.org/docs/int/quickstart/create-cluster"
                    };
                    
                    // Process each file
                    for (const file of filesWithContent) {
                        const lines = file.content.split('\n');
                        totalLines += lines.length;
                        
                        report += `### Analyzing ${file.name} (${file.type.toUpperCase()})\n`;
                        report += `- Lines: ${lines.length.toLocaleString()}\n`;
                        report += `- Size: ${(file.content.length / 1024).toFixed(1)}KB\n\n`;
                        
                        for (let i = 0; i < lines.length; i++) {
                            const line = lines[i];
                            const lowerLine = line.toLowerCase();
                            
                            // Extract timestamps
                            const timeMatch = line.match(/\d{4}-\d{2}-\d{2}[T\s]\d{2}:\d{2}:\d{2}/);
                            if (timeMatch) timestamps.push(timeMatch[0]);
                            
                            // Enhanced error classification
                            if (lowerLine.includes('error')) {
                                errorCount++;
                                if (lowerLine.includes('critical') || lowerLine.includes('fatal') || lowerLine.includes('panic')) {
                                    criticalErrors.push({
                                        file: file.name,
                                        line: i + 1,
                                        content: line.trim(),
                                        timestamp: timeMatch ? timeMatch[0] : 'Unknown',
                                        category: categorizeError(line)
                                    });
                                }
                            }
                            
                            if (lowerLine.includes('warn')) warningCount++;
                            
                            // Charon-specific analysis
                            if (file.type === 'charon' || lowerLine.includes('charon')) {
                                if (lowerLine.includes('error') || lowerLine.includes('warn') || lowerLine.includes('failed')) {
                                    charonIssues.push({
                                        file: file.name,
                                        content: line.trim(),
                                        timestamp: timeMatch ? timeMatch[0] : 'Unknown',
                                        issueType: detectCharonIssueType(line)
                                    });
                                }
                            }
                            
                            // Consensus analysis
                            if (lowerLine.includes('consensus') || lowerLine.includes('qbft') || lowerLine.includes('leader')) {
                                consensusEvents.push({
                                    file: file.name,
                                    content: line.trim(),
                                    timestamp: timeMatch ? timeMatch[0] : 'Unknown'
                                });
                            }
                            
                            // Relay analysis
                            if ((lowerLine.includes('relay') || lowerLine.includes('mev')) && 
                                (lowerLine.includes('error') || lowerLine.includes('timeout') || lowerLine.includes('failed'))) {
                                relayIssues.push({
                                    file: file.name,
                                    content: line.trim(),
                                    timestamp: timeMatch ? timeMatch[0] : 'Unknown',
                                    relay: extractRelayName(line)
                                });
                            }
                            
                            // Network issues
                            if (lowerLine.includes('discovery') || lowerLine.includes('p2p') || lowerLine.includes('network')) {
                                if (lowerLine.includes('timeout') || lowerLine.includes('failed') || lowerLine.includes('error')) {
                                    networkIssues.push({
                                        file: file.name,
                                        content: line.trim(),
                                        timestamp: timeMatch ? timeMatch[0] : 'Unknown'
                                    });
                                }
                            }
                        }
                    }
                    
                    // Build comprehensive report
                    report += `## ðŸ“Š DVT Cluster Analysis Summary\n`;
                    report += `- **Analysis Date**: ${new Date().toLocaleString()}\n`;
                    report += `- **Files Processed**: ${filesWithContent.length}\n`;
                    report += `- **Total Lines**: ${totalLines.toLocaleString()}\n`;
                    report += `- **Time Range**: ${timestamps.length > 0 ? `${timestamps[0]} to ${timestamps[timestamps.length-1]}` : 'Not detected'}\n`;
                    report += `- **Critical Issues**: ${criticalErrors.length}\n`;
                    report += `- **Total Errors**: ${errorCount}\n`;
                    report += `- **Total Warnings**: ${warningCount}\n\n`;
                    
                    // DVT Health Score
                    const healthScore = Math.max(0, 100 - (criticalErrors.length * 20) - (errorCount * 2) - (warningCount * 1));
                    report += `### ðŸ¥ DVT Cluster Health Score: ${healthScore}/100\n`;
                    if (healthScore >= 80) report += `âœ… **Excellent** - Cluster operating optimally\n`;
                    else if (healthScore >= 60) report += `âš ï¸ **Good** - Minor issues detected\n`;
                    else if (healthScore >= 40) report += `ðŸŸ  **Warning** - Several issues need attention\n`;
                    else report += `ðŸ”´ **Critical** - Immediate action required\n\n`;
                    
                    // Obol Network Reference
                    report += `ðŸ“š **Obol Network Documentation**: [${obolDocs.base}](${obolDocs.base})\n\n`;
                    
                    // Critical Issues with Obol Documentation
                    if (criticalErrors.length > 0) {
                        report += `## ðŸš¨ CRITICAL ISSUES (${criticalErrors.length})\n`;
                        criticalErrors.slice(0, 5).forEach((error, i) => {
                            report += `### ${i + 1}. ${error.file}:${error.line}\n`;
                            report += `**Time**: ${error.timestamp}\n`;
                            report += `**Error**: \`${error.content.substring(0, 100)}...\`\n`;
                            report += `**Category**: ${error.category}\n`;
                            
                            // Add specific Obol documentation based on error category
                            switch (error.category) {
                                case 'consensus':
                                    report += `**ðŸ“– Reference**: [DVT Consensus Guide](${obolDocs.consensus})\n`;
                                    break;
                                case 'charon':
                                    report += `**ðŸ“– Reference**: [Charon Troubleshooting](${obolDocs.troubleshooting})\n`;
                                    break;
                                case 'mev-boost':
                                    report += `**ðŸ“– Reference**: [MEV-Boost Integration](${obolDocs.mevBoost})\n`;
                                    break;
                                case 'network':
                                    report += `**ðŸ“– Reference**: [Networking Guide](${obolDocs.networking})\n`;
                                    break;
                                default:
                                    report += `**ðŸ“– Reference**: [General Troubleshooting](${obolDocs.troubleshooting})\n`;
                            }
                            report += `\n`;
                        });
                    }
                    
                    // Charon Analysis
                    if (charonIssues.length > 0) {
                        report += `## ðŸ”— Charon (DVT Middleware) Analysis (${charonIssues.length} issues)\n`;
                        charonIssues.slice(0, 3).forEach((issue, i) => {
                            report += `${i + 1}. **${issue.timestamp}**: \`${issue.content.substring(0, 80)}...\`\n`;
                        });
                        report += `**ðŸ“– Charon Documentation**: [${obolDocs.charon}](${obolDocs.charon})\n`;
                        report += `**ðŸ“– Configuration Guide**: [${obolDocs.charonConfig}](${obolDocs.charonConfig})\n\n`;
                    } else if (filesWithContent.some(f => f.type === 'charon')) {
                        report += `## ðŸ”— Charon (DVT Middleware) Analysis\n`;
                        report += `âœ… **No Charon issues detected** - Middleware operating normally\n`;
                        report += `**ðŸ“– Monitoring Guide**: [${obolDocs.monitoring}](${obolDocs.monitoring})\n\n`;
                    }
                    
                    // Consensus Analysis
                    if (consensusEvents.length > 0) {
                        report += `## ðŸ¤ DVT Consensus Analysis (${consensusEvents.length} events)\n`;
                        report += `âœ… **Consensus activity detected**\n`;
                        const latest = consensusEvents[consensusEvents.length - 1];
                        report += `**Latest Event**: ${latest.timestamp}\n`;
                        report += `**Details**: \`${latest.content.substring(0, 80)}...\`\n`;
                        report += `**ðŸ“– Learn More**: [DVT Consensus](${obolDocs.consensus})\n\n`;
                    } else {
                        report += `## ðŸ¤ DVT Consensus Analysis\n`;
                        report += `âš ï¸ **No consensus events detected**\n`;
                        report += `**ðŸ“– Cluster Setup**: [${obolDocs.cluster}](${obolDocs.cluster})\n`;
                        report += `**ðŸ“– Troubleshooting**: [${obolDocs.troubleshooting}](${obolDocs.troubleshooting})\n\n`;
                    }
                    
                    // MEV Relay Analysis
                    if (relayIssues.length > 0) {
                        report += `## ðŸ“¡ MEV-Boost Relay Analysis (${relayIssues.length} issues)\n`;
                        relayIssues.slice(0, 3).forEach((issue, i) => {
                            report += `${i + 1}. **${issue.relay}** (${issue.timestamp}): \`${issue.content.substring(0, 60)}...\`\n`;
                        });
                        report += `**ðŸ“– MEV-Boost Guide**: [${obolDocs.mevBoost}](${obolDocs.mevBoost})\n\n`;
                    } else {
                        report += `## ðŸ“¡ MEV-Boost Relay Analysis\n`;
                        report += `âœ… **No relay issues detected**\n`;
                        report += `**ðŸ“– Optimization Guide**: [${obolDocs.mevBoost}](${obolDocs.mevBoost})\n\n`;
                    }
                    
                    // Network Analysis
                    if (networkIssues.length > 0) {
                        report += `## ðŸŒ Network & P2P Analysis (${networkIssues.length} issues)\n`;
                        networkIssues.slice(0, 3).forEach((issue, i) => {
                            report += `${i + 1}. **${issue.timestamp}**: \`${issue.content.substring(0, 80)}...\`\n`;
                        });
                        report += `**ðŸ“– Networking Guide**: [${obolDocs.networking}](${obolDocs.networking})\n\n`;
                    }
                    
                    // Comprehensive Recommendations
                    report += `## ðŸŽ¯ Actionable Recommendations\n\n`;
                    
                    if (criticalErrors.length > 0) {
                        report += `### ðŸš¨ IMMEDIATE ACTIONS:\n`;
                        report += `1. **Address ${criticalErrors.length} critical errors** immediately\n`;
                        report += `2. **Check DVT cluster status** and node connectivity\n`;
                        report += `3. **Verify Charon middleware** is running on all nodes\n`;
                        report += `**ðŸ“– Emergency Guide**: [${obolDocs.troubleshooting}](${obolDocs.troubleshooting})\n\n`;
                    }
                    
                    if (charonIssues.length > 0) {
                        report += `### ðŸ”— Charon Optimization:\n`;
                        report += `1. **Review Charon configuration** and restart if needed\n`;
                        report += `2. **Check P2P connectivity** between cluster nodes\n`;
                        report += `3. **Verify distributed validator keys** are properly loaded\n`;
                        report += `**ðŸ“– Charon Guide**: [${obolDocs.charonConfig}](${obolDocs.charonConfig})\n\n`;
                    }
                    
                    if (consensusEvents.length === 0) {
                        report += `### ðŸ¤ Consensus Setup:\n`;
                        report += `1. **Verify DVT cluster formation** and member participation\n`;
                        report += `2. **Check split validator keys** distribution\n`;
                        report += `3. **Review cluster configuration** files\n`;
                        report += `**ðŸ“– Cluster Setup**: [${obolDocs.cluster}](${obolDocs.cluster})\n\n`;
                    }
                    
                    report += `### ðŸ“Š General DVT Optimizations:\n`;
                    report += `1. **Implement Obol monitoring** for cluster health\n`;
                    report += `2. **Set up automated alerts** for consensus failures\n`;
                    report += `3. **Regular backup** of distributed validator keys\n`;
                    report += `4. **Performance tuning** based on cluster metrics\n`;
                    report += `**ðŸ“– Monitoring Setup**: [${obolDocs.monitoring}](${obolDocs.monitoring})\n\n`;
                    
                    // Quick Start Resources
                    report += `## ðŸš€ Obol Network Resources\n`;
                    report += `- **New to Obol?** [Quick Start Guide](${obolDocs.quickStart})\n`;
                    report += `- **Charon Setup** [Configuration Guide](${obolDocs.charonConfig})\n`;
                    report += `- **Need Help?** [Troubleshooting](${obolDocs.troubleshooting})\n`;
                    report += `- **Performance Issues?** [Optimization Guide](${obolDocs.monitoring})\n\n`;
                    
                    report += `---\n`;
                    report += `*Enhanced DVT Analysis with Obol Network Documentation*\n`;
                    report += `*Processed ${totalLines.toLocaleString()} lines in ${filesWithContent.length} files*\n`;
                    report += `*ðŸ“š Powered by [Obol Network](${obolDocs.base})*`;
                    
                    return report;
                };

                // Enhanced AI Analysis with Obol Context
                const analyzeWithClaude = async (filesWithContent) => {
                    console.log('Starting AI analysis with Obol documentation integration...');
                    
                    const prompt = `You are an expert Obol Network DVT log analyzer. Analyze these logs with specific Obol documentation references:

FILES: ${filesWithContent.map(f => `${f.name} (${f.type}): ${f.content.split('\n').length} lines`).join(', ')}

Focus on:
1. DVT consensus & Charon middleware status
2. Cluster health & node participation  
3. MEV-Boost integration issues
4. P2P networking problems
5. Performance optimization opportunities

Include specific Obol documentation links from docs.obol.org for each issue.

LOG SAMPLES:
${filesWithContent.map(f => `### ${f.name}\n${f.content.slice(0, 2000)}`).join('\n\n')}

Provide concise analysis with Obol documentation references.`;

                    const response = await fetch('/api/analyze', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ prompt })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Request failed');
                    }

                    const data = await response.json();
                    
                    if (data.success) {
                        return data.analysis + `

## ðŸ“š Obol Network Resources

### Essential Links:
- **ðŸš€ Quick Start**: [docs.obol.org/docs/start/quickstart_group](https://docs.obol.org/docs/start/quickstart_group)
- **ðŸ”§ Troubleshooting**: [docs.obol.org/docs/advanced/troubleshooting](https://docs.obol.org/docs/advanced/troubleshooting)
- **ðŸ”— Charon Setup**: [docs.obol.org/docs/charon/run/docker](https://docs.obol.org/docs/charon/run/docker)
- **ðŸ“Š Monitoring**: [docs.obol.org/docs/advanced/monitoring](https://docs.obol.org/docs/advanced/monitoring)
- **ðŸ’Ž MEV-Boost**: [docs.obol.org/docs/advanced/mev-boost](https://docs.obol.org/docs/advanced/mev-boost)

---
*AI Analysis enhanced with Obol Network documentation*`;
                    } else {
                        throw new Error(data.error || 'Analysis failed');
                    }
                };

                const analyze = async () => {
                    if (files.length === 0) {
                        alert('Please upload at least one log file');
                        return;
                    }

                    // Smart file size checking
                    const totalSize = files.reduce((sum, f) => sum + f.size, 0);
                    const totalSizeMB = totalSize / (1024 * 1024);
                    
                    if (useAI && totalSizeMB > 1) {
                        const switchToLocal = confirm(
                            `Files are ${totalSizeMB.toFixed(1)}MB. AI analysis may timeout.\n\n` +
                            `Switch to Enhanced Local Analysis? (Recommended for large files)`
                        );
                        if (switchToLocal) {
                            setUseAI(false);
                        }
                    }

                    setLoading(true);
                    console.log('Starting analysis...', { useAI, filesCount: files.length });
                    
                    try {
                        const filesWithContent = await Promise.all(
                            files.map(async (f) => ({
                                ...f,
                                content: await readFileContent(f.file)
                            }))
                        );

                        console.log('Files read successfully');

                        let result;
                        if (useAI) {
                            result = await analyzeWithClaude(filesWithContent);
                        } else {
                            result = await analyzeLogsLocally(filesWithContent);
                        }

                        setAnalysis({
                            timestamp: new Date().toISOString(),
                            filesAnalyzed: files.length,
                            result: result,
                            method: useAI ? 'Claude AI (Obol-Enhanced)' : 'Enhanced Local Analysis (Obol-Integrated)'
                        });

                        console.log('Analysis completed successfully');

                    } catch (error) {
                        console.error('Analysis failed:', error);
                        alert('Analysis failed: ' + error.message + '\n\nTry Enhanced Local Analysis for reliable results.');
                    } finally {
                        setLoading(false);
                    }
                };

                const downloadReport = () => {
                    if (!analysis) return;
                    
                    const report = analysis.result + "\n\n---\nGenerated: " + new Date(analysis.timestamp).toLocaleString() + "\nFiles: " + analysis.filesAnalyzed + "\nMethod: " + analysis.method + "\nPowered by Obol Network Documentation";
                    
                    const blob = new Blob([report], { type: 'text/markdown' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a
